{"version":3,"sources":["../src/index.js"],"names":["axios","require","config","socket","process","env","SOCKET_URL","on","console","log","emit","FIRESTATION","m","notifyDevices","devices","JSON","parse","DEVICES","length","options","headers","auth","username","DEVICE_USERNAME","password","DEVICE_PASSWORD","device","res","get","ip","name","turnOffDelay","data","has_timer","setTimeout","err","message"],"mappings":"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","sourcesContent":["import io from 'socket.io-client';\nconst axios = require('axios');\nrequire('dotenv').config();\n\n// check env values\nrequire('./envCheck')();\n\nconst socket = io(process.env.SOCKET_URL);\n// join fs room on connection\nsocket.on('connect', () => {\n  console.log('connected to socket server');\n  socket.emit('joinFSRoom', process.env.FIRESTATION);\n});\n\n// register on welcome messaage\nsocket.on('welcomeMsg', async (m) => {\n  console.log(m);\n  // send device id to the socket\n});\n\n// on received alarms\nsocket.on('newAlarm', async (m) => {\n  await notifyDevices();\n  console.log('Done with calling the on prem devices');\n});\n\n// on practice alarms\nsocket.on('practiceAlarm', async (m) => {\n  await notifyDevices();\n  console.log('Done with calling the on prem devices');\n});\n\n// function on missing connection\nsocket.on('fsNotFound', (m) => {\n  console.log(m);\n});\n\n// function on missing connection\nsocket.on('disconnect', () => {\n  console.log('disconnected');\n});\n\n// Function to toggle all on prem IoT devices on incoming alarm\nconst notifyDevices = async () => {\n  const devices = JSON.parse(process.env.DEVICES) || [];\n  if (devices.length < 1) {\n    console.log('No on prem devices specified');\n    return;\n  }\n  console.log(devices);\n\n  const options = {\n    headers: {\n      'Content-Type': 'application/x-www-form-urlencoded',\n    },\n    auth: {\n      username: process.env.DEVICE_USERNAME,\n      password: process.env.DEVICE_PASSWORD,\n    },\n  };\n\n  // call the turn on API to send IO signal. The device is set up so it turn off automatically after 1 second\n  // for a backup, we send turn off command if the device has lost the settings\n  for await (const device of devices) {\n    let res;\n    try {\n      res = await axios.get(\n        `http://${device.ip}/relay/0?turn=on`,\n        options,\n      );\n      console.log(`Finished activating device: ${device.name}`);\n      // console.log(res.data);\n\n      const turnOffDelay = device.turnOffDelay || 2000;\n\n      if (!res.data.has_timer) {\n        // timeout for x seconds before sending turn off signal if device has no timer set up\n        setTimeout(async () => {\n          console.log(`send off signal to ${device.name}`);\n          res = await axios.get(\n            `http://${device.ip}/relay/0?turn=off`,\n            options,\n          );\n        }, turnOffDelay);\n      }\n    } catch (err) {\n      console.log(`error: ${err.message}`);\n    }\n  }\n};\n"],"file":"index.js"}